---
title: 单片机远程升级（三）——升级步骤
date: 2023-01-16 16:41:21
tags: 单片机
categories: 单片机
---

## 一、程序远程升级的步骤

1.上位机发送升级请求指令。

2.下位机回复收到请求升级指令。

3.上位机发送程序升级数据（一般包含包头、包号、总包数、分包的程序数据、校验）。

4.单片机收到程序数据后，确认校验无误，存储到程序缓存区，并按包号回复上位机，防止出现传输包错乱。

5.单片机收到回复后再发送下一包数据，直至结束。

6.程序数据发送完成后，单片机发送升级结束指令。

7.单片机收到结束指令后，回复上位机。并在Flash指令位置写入升级标志，重启进入BOOT程序。

8.BOOT陈旭读取升级标志，若需要升级，则读取程序缓存区数据，写入到Flash中。

9.升级完毕，跳转到Flash指定地址运行。

## 二、内存分配

开发BootLoader前，首先需要规划MCU的ROM分区，给BOOT和APP预留足够的空间，避免BootLoader程序编译后的固件大小超出所属空间，从而影响用户程序（APP）区，常用的内存分配图

如下：

|      MCU分区      |               内容描述                |       备注       |
| :---------------: | :-----------------------------------: | :--------------: |
|    BootLoader     |    中断向量表<br />Boot可执行程序     |                  |
| 用户程序区（APP） | 重定向的中断向量表<br />APP可执行程序 |   需要软件配置   |
|    数据储存区     |        系统需要下点保存的数据         | 可选择划分该区域 |

## 三、程序跳转

在MCU升级完成或者是在一定时间内未收到升级请求，那么就需要验证APP程序是否有效（比如擦除后烧写失败则APP程序不完整，在APP执行中会出错），才能进行跳转。

#### 验证原因：

- BOOT和APP属于单独工程，若一新的MCU先烧录BOOT程序，则上电后无APP程序，则会引起MCU异常中断。
- APP程序擦除后烧写失败则导致APP程序不完整，跳转后也会引起MCU异常中断。
- APP程序存在但代码数据因为不可抗因素出现错乱，跳转后也会引起MCU异常中断或者用户程序功能异常等。

#### 如何验证？

- 验证APP程序是否存在且完整，通常做法是在指定的APP程序区设置一标志位，表示APP程序存在（擦除时该标志也会一并擦除）
- 对APP程序进行校验，防止APP程序存在但因为不可抗因素出现代码错乱的问题。

#### 验证结束

- 在验证结束后，若验证成果，则准备跳转APP程序，在跳转之前需要BOOT关闭相关功能，防止跳转时或者跳转后出错。
- 跳转至APP后，需要进行重定向中断向量表，否则无法正常进入APP程序区的中断执行函数，具体原因可先了解中断向量表的含义及作用。
